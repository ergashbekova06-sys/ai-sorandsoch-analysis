import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt

st.set_page_config(page_title="–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –°–û–†/–°–û–ß", layout="wide")

st.title("üìä –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –°–û–† –∏ –°–û–ß –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∫–ª–∞—Å—Å–∞–º")

uploaded_files = st.file_uploader(
    "–ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ Excel",
    type=["xlsx", "xls"],
    accept_multiple_files=True
)

def extract_table(df):
    """
    –ò—â–µ–º —Å—Ç—Ä–æ–∫—É, –≥–¥–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Ç–∞–±–ª–∏—Ü–∞ (–∫–æ–ª–æ–Ω–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å–æ —Å–ª–æ–≤–∞ '–ü—Ä–µ–¥–º–µ—Ç'),
    –∑–∞—Ç–µ–º –±–µ—Ä–µ–º —Å–ª–µ–¥—É—é—â–∏–µ —Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏ ‚Äî –°–û–†1, –°–û–†2, –°–û–ß.
    """
    start_row = None
    for i in range(len(df)):
        val = df.iloc[i, 0]
        if isinstance(val, str) and "–ü—Ä–µ–¥–º–µ—Ç" in val:
            start_row = i
            break

    if start_row is None:
        return None

    table = df.iloc[start_row + 1 : start_row + 4, 0:8]
    table.columns = [
        "–ü—Ä–µ–¥–º–µ—Ç",
        "–£—á–µ–Ω–∏–∫",
        "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª",
        "–Ω–∏–∑–∫–∏–π",
        "—Å—Ä–µ–¥–Ω–∏–π",
        "–≤—ã—Å–æ–∫–∏–π",
        "% –∫–∞—á–µ—Å—Ç–≤–∞",
        "% —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏",
    ]

    return table


if uploaded_files:
    all_tables = []

    for f in uploaded_files:
        df = pd.read_excel(f, header=None)
        table = extract_table(df)

        if table is None:
            st.error(f"–í —Ñ–∞–π–ª–µ {f.name} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞.")
            continue

        table["–§–∞–π–ª"] = f.name  # –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        all_tables.append(table)

    if len(all_tables) == 0:
        st.stop()

    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
    final_df = pd.concat(all_tables, ignore_index=True)

    st.subheader("üìå –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ –≤—Å–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º —Ñ–∞–π–ª–∞–º")
    st.dataframe(final_df)

    # ------------------------------------------
    # –î–ò–ê–ì–†–ê–ú–ú–ê (—Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –≤—Å–µ–º —Ñ–∞–π–ª–∞–º)
    # ------------------------------------------
    st.subheader("üìà –î–∏–∞–≥—Ä–∞–º–º–∞ —Å—Ä–µ–¥–Ω–∏—Ö % –∫–∞—á–µ—Å—Ç–≤–∞ –∏ % —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏")

    plot_df = final_df.groupby("–ü—Ä–µ–¥–º–µ—Ç")[["% –∫–∞—á–µ—Å—Ç–≤–∞", "% —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏"]].mean()

    fig, ax = plt.subplots()
    plot_df.plot(kind="bar", ax=ax)
    ax.set_ylabel("–ü—Ä–æ—Ü–µ–Ω—Ç—ã")
    ax.set_title("–°—Ä–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ –°–û–†/–°–û–ß")
    st.pyplot(fig)

    # ------------------------------------------
    # –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò
    # ------------------------------------------
    st.subheader("üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏")

    low_quality = final_df.loc[final_df["% –∫–∞—á–µ—Å—Ç–≤–∞"].idxmin()]
    low_success = final_df.loc[final_df["% —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏"].idxmin()]

    st.markdown(f"""
    ### –¢–µ–º—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è:
    - –ù–∞–∏–±–æ–ª–µ–µ –Ω–∏–∑–∫–∏–π % –∫–∞—á–µ—Å—Ç–≤–∞ –Ω–∞–±–ª—é–¥–∞–µ—Ç—Å—è –≤: **{low_quality['–ü—Ä–µ–¥–º–µ—Ç']}**  
      (—Ñ–∞–π–ª: *{low_quality['–§–∞–π–ª']}*, –∫–∞—á–µ—Å—Ç–≤–æ: **{low_quality['% –∫–∞—á–µ—Å—Ç–≤–∞']}%**)

    - –ù–∞–∏–±–æ–ª–µ–µ –Ω–∏–∑–∫–∞—è —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å ‚Äî –≤: **{low_success['–ü—Ä–µ–¥–º–µ—Ç']}**  
      (—Ñ–∞–π–ª: *{low_success['–§–∞–π–ª']}*, —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å: **{low_success['% —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏']}%**)

    ### –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
    - –ü—Ä–æ–≤–µ—Å—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –æ—à–∏–±–æ–∫ –≤ –°–û–†/–°–û–ß –ø–æ –≤—ã—è–≤–ª–µ–Ω–Ω—ã–º —Å–ª–∞–±—ã–º —Ç–æ—á–∫–∞–º.
    - –û–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ç–µ–º—ã, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –Ω–∞–±–ª—é–¥–∞–µ—Ç—Å—è –≤—ã—Å–æ–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
    - –£—Å–∏–ª–∏—Ç—å –ø—Ä–æ—Ä–∞–±–æ—Ç–∫—É –∑–∞–¥–∞–Ω–∏–π –Ω–∞ –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏.
    - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞.
    - –ü—Ä–æ–≤–µ—Å—Ç–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É —Å —É—á–∞—â–∏–º–∏—Å—è, –∏–º–µ—é—â–∏–º–∏ –Ω–∏–∑–∫–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.
    """)

    st.success("–ê–Ω–∞–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω!")
